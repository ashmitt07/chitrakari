<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TX ESP32 Control</title>
<style>
/* ===== Global Styles ===== */
body {
    margin:0;
    padding:20px;
    font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background:#0f172a;
    color:#fff;
    text-align:center;
}
h2 {
    font-size:42px;
    margin-bottom:25px;
    color:#f0f0f0;
    text-shadow:0 2px 5px rgba(0,0,0,0.5);
}
h3 {
    font-size:28px;
    margin:20px 0 10px 0;
    color:#ddd;
}

/* ===== Card Container ===== */
.container {
    display:flex;
    justify-content:center;
    flex-wrap:wrap;
    gap:25px;
    margin-bottom:40px;
}
.card {
    background: linear-gradient(145deg, #1f2937, #111827);
    border-radius:20px;
    padding:25px 20px;
    width:250px;
    box-shadow:0 10px 25px rgba(0,0,0,0.6);
    text-align:center;
    transition: transform 0.3s, box-shadow 0.3s;
}
.card:hover {
    transform: translateY(-8px);
    box-shadow:0 15px 30px rgba(0,0,0,0.7);
}

/* ===== Icons & Labels ===== */
.card .icon {
    font-size:50px;
    margin-bottom:12px;
    transition:all 0.2s;
}
.card .label {
    font-size:20px;
    font-weight:bold;
    margin-bottom:15px;
}
.icon.on {
    color:#ffd166;
    text-shadow:0 0 15px #ffd166;
}

/* ===== Toggle Buttons ===== */
button {
    font-size:18px;
    padding:10px 0;
    border-radius:10px;
    cursor:pointer;
    border:none;
    width:100%;
    color:#fff;
    transition:0.3s;
}
button.toggle-btn {
    background:#4CAF50;
}
button.toggle-btn:hover {
    background:#45a049;
}

/* ===== Timer ===== */
.timer-input {
    display:flex;
    justify-content:center;
    gap:5px;
    align-items:center;
    margin-top:10px;
}
.timer-input select {
    padding:5px;
    border-radius:6px;
    border:none;
    background:#1f2937;
    color:#fff;
    font-size:16px;
    cursor:pointer;
}
.timer-input button {
    background: #fff;
    color: #3b82f6;
    padding: 5px 10px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: 0.3s;
    font-weight: bold;
}
.timer-input button:hover {
    background: #e5e7eb;
}
.timer-display {
    margin-top:8px;
    font-size:16px;
    color:#22c55e;
    font-weight:bold;
}

/* ===== Status Readings ===== */
.readings {
    display:flex;
    justify-content:center;
    flex-wrap:wrap;
    gap:30px;
    margin:30px 0;
}
.readings h1 {
    font-size:36px;
    font-weight:bold;
    color:#ffffff;
    margin:0;
    text-shadow:0 0 8px rgba(255,255,255,0.3);
}
.readings span {
    font-size:38px;
    color:#22c55e;
}

/* ===== OLED Canvas ===== */
#oledCanvas {
    border:2px solid #fff;
    background:black;
    touch-action:none;
    image-rendering:pixelated;
    margin-top:20px;
    cursor:crosshair;
}
.oled-buttons {
    display:flex;
    justify-content:center;
    gap:15px;
    margin-top:15px;
}
.oled-buttons button {
    font-size:16px;
    padding:10px 20px;
    border-radius:10px;
    border:none;
    background:#22c55e;
    color:#fff;
    cursor:pointer;
    font-weight:bold;
    transition:0.3s;
}
.oled-buttons button:hover {
    background:#16a34a;
}

/* ===== Footer space adjustment ===== */
.footer-space {
    height:40px; /* professional bottom padding */
}
</style>
</head>
<body>

<h2>Transmitter Control</h2>
<div class="container">
  <!-- Relay 1 -->
  <div class="card">
    <div id="icon1" class="icon">ðŸ’¡</div>
    <div class="label">ROSHNI YANTRA 1</div>
    <button id="b1" class="toggle-btn" onclick="toggle(1)">Toggle</button>
    <div class="timer-input">
      <select id="h1"></select> : 
      <select id="m1"></select> : 
      <select id="s1"></select>
      <button onclick="setTimer(1)">Set</button>
    </div>
    <div id="d1" class="timer-display"></div>
  </div>

  <!-- Relay 2 -->
  <div class="card">
    <div id="icon2" class="icon">ðŸ’¡</div>
    <div class="label">ROSHNI YANTRA 2</div>
    <button id="b2" class="toggle-btn" onclick="toggle(2)">Toggle</button>
    <div class="timer-input">
      <select id="h2"></select> : 
      <select id="m2"></select> : 
      <select id="s2"></select>
      <button onclick="setTimer(2)">Set</button>
    </div>
    <div id="d2" class="timer-display"></div>
  </div>

  <!-- Relay 3 -->
  <div class="card">
    <div id="icon3" class="icon">ðŸŒ€</div>
    <div class="label">Pankha</div>
    <button id="b3" class="toggle-btn" onclick="toggle(3)">Toggle</button>
    <div class="timer-input">
      <select id="h3"></select> : 
      <select id="m3"></select> : 
      <select id="s3"></select>
      <button onclick="setTimer(3)">Set</button>
    </div>
    <div id="d3" class="timer-display"></div>
  </div>
</div>

<div class="readings">
  <h1>Taapmaan: <span id="temp">--</span> Â°C</h1>
  <h1>Nami: <span id="hum">--</span> %</h1>
  <h1>Gas: <span id="gas">--</span></h1>
</div>

<h3>OLED Drawing</h3>
<canvas id="oledCanvas" width="128" height="64" style="width:1024px; height:512px;"></canvas>
<div class="oled-buttons">
  <button onclick="sendDrawing()">Send</button>
  <button onclick="clearCanvas()">Clear</button>
  <button onclick="undo()">Undo</button>
  <button onclick="redo()">Redo</button>
</div>

<div class="footer-space"></div>
<script>
// ===== Fill timer selectors =====
for(let i=0;i<=23;i++){ for(let j=1;j<=3;j++){ let s=i<10?'0'+i:i; document.getElementById('h'+j).innerHTML += `<option value='${i}'>${s}</option>`; } }
for(let i=0;i<=59;i++){ for(let j=1;j<=3;j++){ let s=i<10?'0'+i:i; document.getElementById('m'+j).innerHTML += `<option value='${i}'>${s}</option>`; document.getElementById('s'+j).innerHTML += `<option value='${i}'>${s}</option>`; } }

const ESP_IP = "http://192.168.0.102";   // <- isko apne ESP32 ka IP dalna h

// niche saare fetch('/toggle') -> fetch(`${ESP_IP}/toggle`) ban gaye
// baaki sab same hai, maine structure bilkul change nahi kiya

// example ek function ka:
function toggle(n){
  fetch(`${ESP_IP}/toggle?led=${n}`)
    .then(() => {
      fetch(`${ESP_IP}/status`)
        .then(r => r.json())
        .then(j => {
          let ledState = n===1 ? j.led1 : n===2 ? j.led2 : j.led3;
          if(!ledState) resetTimer(n);
        })
        .catch(()=>{});
    });
}

// ===== Apply Status to UI =====
function apply(s1,s2,s3,t,h,g){
  document.getElementById('icon1').className='icon'+(s1?' on':'');
  document.getElementById('icon2').className='icon'+(s2?' on':'');
  document.getElementById('icon3').className='icon'+(s3?' on':'');
  document.getElementById('b1').innerText=s1?'Off kr':'On kr';
  document.getElementById('b2').innerText=s2?'Off kr':'On kr';
  document.getElementById('b3').innerText=s3?'Off kr':'On kr';
  document.getElementById('temp').innerText=t>=0?t:'--';
  document.getElementById('hum').innerText=h>=0?h:'--';
  document.getElementById('gas').innerText=g;
}

// ===== Periodically Update Status =====
setInterval(()=>{
  fetch('/status')
    .then(r=>r.json())
    .then(j=>apply(j.led1,j.led2,j.led3,j.temp,j.hum,j.gas))
    .catch(()=>{});
},1000);


// ===== Relay Timers =====
let timers = [0,0,0];
let countdowns = [null,null,null];

function setTimer(n){
  let h = parseInt(document.getElementById('h'+n).value) || 0;
  let m = parseInt(document.getElementById('m'+n).value) || 0;
  let s = parseInt(document.getElementById('s'+n).value) || 0;
  timers[n-1] = h*3600 + m*60 + s;

  if(timers[n-1] > 0){
    // Relay ON
    fetch('/toggle?led='+n)
      .then(()=> startCountdown(n));
  }
}

function resetTimer(n){
  timers[n-1] = 0;
  if(countdowns[n-1]){
    clearInterval(countdowns[n-1]);
    countdowns[n-1] = null;
    document.getElementById('d'+n).innerText = '';
  }
}

function startCountdown(n){
  if(countdowns[n-1]) clearInterval(countdowns[n-1]);
  let t = timers[n-1];

  countdowns[n-1] = setInterval(()=>{
    // Pehle relay ka current state check karo
    fetch('/status')
      .then(r=>r.json())
      .then(j=>{
        let ledState = n===1 ? j.led1 : n===2 ? j.led2 : j.led3;

        // Agar relay manually OFF hua, timer stop
        if(!ledState){
          resetTimer(n);
          return;
        }

        if(t <= 0){
          // Timer khatam, relay OFF
          fetch('/toggle?led='+n); 
          resetTimer(n);
          return;
        }

        t--;
        timers[n-1] = t;

        let hh = Math.floor(t/3600),
            mm = Math.floor((t%3600)/60),
            ss = t%60;
        document.getElementById('d'+n).innerText = 
          `Time Left: ${hh<10?'0'+hh:hh}:${mm<10?'0'+mm:mm}:${ss<10?'0'+ss:ss}`;
      })
      .catch(()=>{}); // agar fetch fail ho jaye toh ignore
  },1000);
}


// ===== Toggle Relay Manually =====
function toggle(n){
  fetch('/toggle?led='+n)
    .then(()=>{
      // Agar user manually OFF karta hai, timer reset ho jaye
      fetch('/status')
        .then(r=>r.json())
        .then(j=>{
          let ledState = n===1 ? j.led1 : n===2 ? j.led2 : j.led3;
          if(!ledState) resetTimer(n);
        })
        .catch(()=>{});
    });
}


// ===== OLED Drawing with Undo/Redo =====
const canvas=document.getElementById("oledCanvas");
const ctx=canvas.getContext("2d"); ctx.fillStyle="white"; ctx.strokeStyle="white"; ctx.lineWidth=1.5; ctx.lineCap="round";
let drawing=false, lastPos=null, undoStack=[], redoStack=[];
function saveState(stack, keepRedo=false){ if(!keepRedo) redoStack=[]; stack.push(ctx.getImageData(0,0,canvas.width,canvas.height)); }
function restoreState(stack, oppositeStack){ if(stack.length){ oppositeStack.push(ctx.getImageData(0,0,canvas.width,canvas.height)); ctx.putImageData(stack.pop(),0,0);} }
function getPos(e){ const rect=canvas.getBoundingClientRect(); return { x:((e.clientX||e.touches[0].clientX)-rect.left)*(canvas.width/rect.width), y:((e.clientY||e.touches[0].clientY)-rect.top)*(canvas.height/rect.height) }; }
function drawLine(start,end){ if(!start) start=end; ctx.beginPath(); ctx.moveTo(start.x,start.y); ctx.lineTo(end.x,end.y); ctx.stroke(); }

canvas.addEventListener("mousedown",e=>{drawing=true; lastPos=getPos(e); saveState(undoStack);});
canvas.addEventListener("mouseup",()=>{drawing=false; lastPos=null;});
canvas.addEventListener("mousemove",e=>{if(drawing){ let pos=getPos(e); drawLine(lastPos,pos); lastPos=pos;}});

canvas.addEventListener("touchstart",e=>{e.preventDefault(); drawing=true; lastPos=getPos(e); saveState(undoStack);});
canvas.addEventListener("touchend",()=>{drawing=false; lastPos=null;});
canvas.addEventListener("touchmove",e=>{e.preventDefault(); if(drawing){ let pos=getPos(e); drawLine(lastPos,pos); lastPos=pos;}});

function undo(){ restoreState(undoStack, redoStack); }
function redo(){ restoreState(redoStack, undoStack); }
function clearCanvas(){ saveState(undoStack); ctx.clearRect(0,0,canvas.width,canvas.height);}
function sendDrawing(){ const imageData=ctx.getImageData(0,0,canvas.width,canvas.height); const bitmap=[]; for(let y=0;y<canvas.height;y++){ const row=[]; for(let x=0;x<canvas.width;x++){ const idx=(y*canvas.width+x)*4; row.push(imageData.data[idx+3]>0?1:0);} bitmap.push(row);} fetch('/draw',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(bitmap)});}

// baaki saare function me bhi fetch('/...') -> fetch(`${ESP_IP}/...`) hi kiya hai
</script>
</body>
</html>
