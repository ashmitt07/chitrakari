<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TX ESP32 Control</title>
<style>
/* Same CSS jo pehle diya tha (cards, container, buttons, oled etc.) */
</style>
</head>
<body>
<h2>Transmitter Control</h2>

<div class="container">
  <!-- Relay cards -->
  <div class="card">
    <div id="icon1" class="icon">ðŸ’¡</div>
    <div class="label">ROSHNI YANTRA 1</div>
    <button id="b1" onclick="toggle(1)">Toggle</button>
  </div>
  <div class="card">
    <div id="icon2" class="icon">ðŸ’¡</div>
    <div class="label">ROSHNI YANTRA 2</div>
    <button id="b2" onclick="toggle(2)">Toggle</button>
  </div>
  <div class="card">
    <div id="icon3" class="icon">ðŸŒ€</div>
    <div class="label">Pankha</div>
    <button id="b3" onclick="toggle(3)">Toggle</button>
  </div>
</div>

<div class="readings">
  <h1>Taapmaan: <span id="temp">--</span> Â°C</h1>
  <h1>Nami: <span id="hum">--</span> %</h1>
  <h1>Gas: <span id="gas">--</span></h1>
</div>

<h3>OLED Drawing</h3>
<canvas id="oledCanvas" width="128" height="64" style="width:512px;height:256px;border:2px solid white;"></canvas>
<div>
  <button onclick="sendDrawing()">Send</button>
  <button onclick="clearCanvas()">Clear</button>
</div>

<script>
const ESP32_IP = "http://192.168.0.102"; // <- apne ESP ka IP daalna

function toggle(n){
  fetch(`${ESP32_IP}/toggle?led=${n}`);
}

function updateStatus(){
  fetch(`${ESP32_IP}/status`)
    .then(r=>r.json())
    .then(j=>{
      document.getElementById('icon1').style.color=j.led1?'yellow':'white';
      document.getElementById('icon2').style.color=j.led2?'yellow':'white';
      document.getElementById('icon3').style.color=j.led3?'yellow':'white';
      document.getElementById('temp').innerText=j.temp;
      document.getElementById('hum').innerText=j.hum;
      document.getElementById('gas').innerText=j.gas;
    });
}
setInterval(updateStatus,1000);

// ==== Canvas Drawing ====
const canvas=document.getElementById("oledCanvas");
const ctx=canvas.getContext("2d");
ctx.fillStyle="white";
ctx.strokeStyle="white";
let drawing=false,lastPos=null;

canvas.addEventListener("mousedown",e=>{drawing=true;lastPos=getPos(e);});
canvas.addEventListener("mouseup",()=>{drawing=false;lastPos=null;});
canvas.addEventListener("mousemove",e=>{if(drawing){let pos=getPos(e);drawLine(lastPos,pos);lastPos=pos;}});

function getPos(e){const rect=canvas.getBoundingClientRect();return {x:(e.clientX-rect.left)*(canvas.width/rect.width),y:(e.clientY-rect.top)*(canvas.height/rect.height)};}
function drawLine(s,e){if(!s)s=e;ctx.beginPath();ctx.moveTo(s.x,s.y);ctx.lineTo(e.x,e.y);ctx.stroke();}

function clearCanvas(){ctx.clearRect(0,0,canvas.width,canvas.height);}
function sendDrawing(){
  const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
  const bitmap=[];
  for(let y=0;y<canvas.height;y++){
    const row=[];
    for(let x=0;x<canvas.width;x++){
      const idx=(y*canvas.width+x)*4;
      row.push(imageData.data[idx+3]>0?1:0);
    }
    bitmap.push(row);
  }
  fetch(`${ESP32_IP}/draw`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(bitmap)});
}
</script>
</body>
</html>
